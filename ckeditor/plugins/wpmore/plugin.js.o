CKEDITOR.plugins.add('wpmore',{requires:['fakeobjects'],getPlaceholderCss:function(){return'img.cke_wordpress_more'+'{'+'background-image: url('+CKEDITOR.getUrl(this.path+'images/more_bug.gif')+');'+'background-position: right center;'+'background-repeat: no-repeat;'+'clear: both;'+'display: block;'+'float: none;'+'width: 100%;'+'border-top: #999999 1px dotted;'+'height: 10px;'+'}'},onLoad:function(){if(CKEDITOR.addCss){CKEDITOR.addCss(this.getPlaceholderCss());}},init:function(editor){if(editor.addCss){editor.addCss(this.getPlaceholderCss());}editor.ui.addButton('WPMore',{label:'Insert More Break',icon:this.path+'images/more.gif',command:'wpmore'});editor.addCommand('wpmore',{exec:function(){var images=editor.document.getElementsByTag('img');for(var i=0,len=images.count();i<len;i++){var img=images.getItem(i);if(img.hasClass('cke_wordpress_more')){var msg='The document already contains a more. '+'Do you want to proceed by removing it first?'
if(confirm(msg)){img.remove();break;}else{return;}}}insertComment('more');}});function insertComment(text){if(!CKEDITOR.dom.comment.prototype.getAttribute){CKEDITOR.dom.comment.prototype.getAttribute=function(){return'';};CKEDITOR.dom.comment.prototype.attributes={align:''};}var fakeElement=editor.createFakeElement(new CKEDITOR.dom.comment(text),'cke_wordpress_'+text,'hr');var range=editor.getSelection().getRanges()[0],elementsPath=new CKEDITOR.dom.elementPath(range.getCommonAncestor(true)),element=(elementsPath.block&&elementsPath.block.getParent())||elementsPath.blockLimit,hasMoved;while(element&&element.getName()!='body'){range.moveToPosition(element,CKEDITOR.POSITION_AFTER_END);hasMoved=1;element=element.getParent();}range.insertNode(fakeElement);var next=fakeElement;while((next=next.getNext())&&!range.moveToElementEditStart(next)){}range.select();}},afterInit:function(editor){editor.dataProcessor.dataFilter.addRules({comment:function(value){if(!CKEDITOR.htmlParser.comment.prototype.getAttribute){CKEDITOR.htmlParser.comment.prototype.getAttribute=function(){return'';};CKEDITOR.htmlParser.comment.prototype.attributes={align:''};}if(value=='more'){return editor.createFakeParserElement(new CKEDITOR.htmlParser.comment(value),'cke_wordpress_'+value,'hr');}return value;}});}});